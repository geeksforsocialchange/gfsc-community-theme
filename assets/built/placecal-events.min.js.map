{"version":3,"sources":["placecal-events.js"],"names":["partnerId","futureDays","endpoint","loadingEl","errorEl","emptyEl","listEl","CACHE_KEY","CACHE_TTL","url","xhr","container","document","getElementById","escapeHTML","str","div","createElement","appendChild","createTextNode","innerHTML","padTwo","n","formatTime","dateStr","d","Date","getHours","getMinutes","formatTimeRange","startStr","endStr","range","tz","parts","toLocaleTimeString","timeZoneName","split","length","e","showState","state","hidden","collapseRecurring","events","series","seriesOrder","result","forEach","event","key","repeatFrequency","name","startDate","push","group","next","Object","create","recurrence","toLowerCase","intervals","i","diff","Math","round","counts","modeDays","Number","keys","sort","a","b","renderEvents","existing","collapsed","html","date","getDay","getDate","getMonth","time","endDate","location","address","streetAddress","addressLocality","postalCode","filter","Boolean","join","publisherUrl","id","datetime","toISOString","timeStr","description","replace","p","trim","map","onlineEventUrl","linkLabel","indexOf","querySelector","remove","schemas","hasAddress","hasOnline","schema","@type","eventStatus","image","organizer","offers","price","priceCurrency","availability","summary","eventAttendanceMode","script","type","textContent","JSON","stringify","@context","@graph","processEvents","cutoff","getTime","filtered","getAttribute","parseInt","cached","raw","localStorage","getItem","parse","timestamp","removeItem","encodeURIComponent","XMLHttpRequest","open","onreadystatechange","readyState","status","response","responseText","data","partner","setItem","onerror","send"],"mappings":"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","file":"placecal-events.min.js","sourcesContent":["(function () {\n    'use strict';\n\n    var container = document.getElementById('placecal-events');\n    if (!container) {\n        return;\n    }\n\n    var partnerId = container.getAttribute('data-placecal-partner-id');\n    var futureDays = parseInt(container.getAttribute('data-placecal-future-days'), 10) || 90;\n    var endpoint = container.getAttribute('data-placecal-endpoint');\n\n    var loadingEl = container.querySelector('.gh-events-loading');\n    var errorEl = container.querySelector('.gh-events-error');\n    var emptyEl = container.querySelector('.gh-events-empty');\n    var listEl = container.querySelector('.gh-events-list');\n\n    function escapeHTML(str) {\n        if (!str) {\n            return '';\n        }\n        var div = document.createElement('div');\n        div.appendChild(document.createTextNode(str));\n        return div.innerHTML;\n    }\n\n    // Convert description text into HTML paragraphs.\n    // Strips markdown artefacts from PlaceCal descriptions, escapes HTML,\n    // then splits on double newlines into <p> tags.\n    function formatDescription(str) {\n        if (!str) {\n            return '';\n        }\n        // Strip everything from a --- line onwards (link refs, metadata)\n        var cleaned = str.replace(/\\n\\s*---[\\s\\S]*$/, '');\n        // Unescape markdown characters (\\*, \\', \\_)\n        cleaned = cleaned.replace(/\\\\([*'_])/g, '$1');\n        // Remove reference-style link definitions [n]: url\n        cleaned = cleaned.replace(/^\\s*\\[\\d+\\]:.*$/gm, '');\n        // Convert reference-style links [text][n] to just text\n        cleaned = cleaned.replace(/\\[([^\\]]+)\\]\\[\\d+\\]/g, '$1');\n        // Convert inline links [text](url) to just text\n        cleaned = cleaned.replace(/\\[([^\\]]+)\\]\\([^)]+\\)/g, '$1');\n        // Strip lines that are just a URL\n        cleaned = cleaned.replace(/^\\s*https?:\\/\\/\\S+\\s*$/gm, '');\n        // Convert markdown bullet points (* item) to plain text with bullet\n        cleaned = cleaned.replace(/^\\s*\\*\\s+/gm, '\\u2022 ');\n        var escaped = escapeHTML(cleaned);\n        // Split on markdown-style breaks (double space + newline combos or double newlines)\n        var paragraphs = escaped.split(/\\s*\\n\\s*\\n\\s*/);\n        var filtered = paragraphs.filter(function (p) {\n            var trimmed = p.replace(/\\s+/g, ' ').trim();\n            return trimmed.length > 0;\n        });\n        return filtered.map(function (p) {\n            return '<p>' + p.replace(/\\n/g, '<br>') + '</p>';\n        }).join('');\n    }\n\n    function padTwo(n) {\n        return n < 10 ? '0' + n : '' + n;\n    }\n\n    function formatTime(dateStr) {\n        var d = new Date(dateStr);\n        return padTwo(d.getHours()) + ':' + padTwo(d.getMinutes());\n    }\n\n    function getTimezoneAbbr(dateStr) {\n        try {\n            var parts = new Date(dateStr).toLocaleTimeString('en-GB', { timeZoneName: 'short' }).split(' ');\n            return parts[parts.length - 1] || '';\n        } catch (e) {\n            return '';\n        }\n    }\n\n    function formatTimeRange(startStr, endStr) {\n        var range = formatTime(startStr);\n        if (endStr) {\n            range += ' \\u2013 ' + formatTime(endStr);\n        }\n        var tz = getTimezoneAbbr(startStr);\n        if (tz) {\n            range += ' ' + tz;\n        }\n        return range;\n    }\n\n    function formatShortDate(dateStr) {\n        var d = new Date(dateStr);\n        var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n        return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()];\n    }\n\n    function formatAddress(address) {\n        if (!address) {\n            return '';\n        }\n        var parts = [address.streetAddress, address.addressLocality, address.postalCode];\n        return parts.filter(Boolean).join(', ');\n    }\n\n    function showState(state) {\n        loadingEl.hidden = state !== 'loading';\n        errorEl.hidden = state !== 'error';\n        emptyEl.hidden = state !== 'empty';\n        listEl.hidden = state !== 'events';\n    }\n\n    // Collapse recurring events to show only the next occurrence.\n    // Uses repeatFrequency from the API when available, falls back to\n    // interval detection for events without recurrence data.\n    // Groups by name only when repeatFrequency is set (avoids DST\n    // time shifts splitting the same series into multiple groups).\n    function collapseRecurring(events) {\n        var series = {};\n        var seriesOrder = [];\n\n        events.forEach(function (event) {\n            var key = event.repeatFrequency\n                ? event.name\n                : event.name + '||' + formatTime(event.startDate);\n            if (!series[key]) {\n                series[key] = [];\n                seriesOrder.push(key);\n            }\n            series[key].push(event);\n        });\n\n        var result = [];\n        seriesOrder.forEach(function (key) {\n            var group = series[key];\n            var next = group[0]; // already sorted, first is soonest\n\n            if (next.repeatFrequency) {\n                // API provides recurrence info - show only the next occurrence\n                next = Object.create(next);\n                next.recurrence = next.repeatFrequency.toLowerCase();\n                result.push(next);\n            } else if (group.length > 1) {\n                // No API recurrence info but multiple instances - detect from intervals\n                var intervals = [];\n                for (var i = 1; i < group.length; i++) {\n                    var diff = (new Date(group[i].startDate) - new Date(group[i - 1].startDate));\n                    intervals.push(Math.round(diff / (24 * 60 * 60 * 1000)));\n                }\n                var recurrence = detectRecurrence(intervals);\n                if (recurrence) {\n                    next = Object.create(next);\n                    next.recurrence = recurrence;\n                }\n                result.push(next);\n            } else {\n                result.push(next);\n            }\n        });\n\n        // Re-sort by start date since collapsing changes order\n        result.sort(function (a, b) {\n            return new Date(a.startDate) - new Date(b.startDate);\n        });\n\n        return result;\n    }\n\n    function detectRecurrence(intervals) {\n        if (intervals.length === 0) {\n            return null;\n        }\n        var counts = {};\n        intervals.forEach(function (d) {\n            counts[d] = (counts[d] || 0) + 1;\n        });\n        var modeDays = Number(Object.keys(counts).sort(function (a, b) {\n            return counts[b] - counts[a];\n        })[0]);\n\n        if (modeDays >= 1 && modeDays <= 2) {\n            return 'daily';\n        }\n        if (modeDays >= 6 && modeDays <= 8) {\n            return 'weekly';\n        }\n        if (modeDays >= 13 && modeDays <= 15) {\n            return 'fortnightly';\n        }\n        if (modeDays >= 27 && modeDays <= 32) {\n            return 'monthly';\n        }\n        return null;\n    }\n\n    function recurrenceLabel(recurrence) {\n        return recurrence ? 'Repeats ' + recurrence : '';\n    }\n\n    function buildEventSchema(events) {\n        return events.map(function (event) {\n            var url = event.publisherUrl || ('https://manchester.placecal.org/events/' + event.id);\n            var hasAddress = event.address && (event.address.streetAddress || event.address.postalCode);\n            var hasOnline = !!event.onlineEventUrl;\n\n            var schema = {\n                '@type': 'Event',\n                'name': event.name,\n                'startDate': event.startDate,\n                'eventStatus': 'https://schema.org/EventScheduled',\n                'image': 'https://gfsc.community/content/images/2025/02/GFSC_Community_Logo_Orange_RGB.png',\n                'organizer': {\n                    '@type': 'Organization',\n                    'name': 'Geeks for Social Change',\n                    'url': 'https://gfsc.community/'\n                },\n                'offers': {\n                    '@type': 'Offer',\n                    'price': '0',\n                    'priceCurrency': 'GBP',\n                    'availability': 'https://schema.org/InStock',\n                    'url': url\n                },\n                'url': url\n            };\n\n            if (event.endDate) {\n                schema.endDate = event.endDate;\n            }\n\n            if (event.summary) {\n                schema.description = event.summary;\n            }\n\n            if (hasAddress && hasOnline) {\n                schema.eventAttendanceMode = 'https://schema.org/MixedEventAttendanceMode';\n                schema.location = [\n                    {\n                        '@type': 'Place',\n                        'address': {\n                            '@type': 'PostalAddress',\n                            'streetAddress': event.address.streetAddress || '',\n                            'addressLocality': event.address.addressLocality || '',\n                            'postalCode': event.address.postalCode || ''\n                        }\n                    },\n                    {\n                        '@type': 'VirtualLocation',\n                        'url': event.onlineEventUrl\n                    }\n                ];\n            } else if (hasOnline) {\n                schema.eventAttendanceMode = 'https://schema.org/OnlineEventAttendanceMode';\n                schema.location = {\n                    '@type': 'VirtualLocation',\n                    'url': event.onlineEventUrl\n                };\n            } else if (hasAddress) {\n                schema.eventAttendanceMode = 'https://schema.org/OfflineEventAttendanceMode';\n                schema.location = {\n                    '@type': 'Place',\n                    'address': {\n                        '@type': 'PostalAddress',\n                        'streetAddress': event.address.streetAddress || '',\n                        'addressLocality': event.address.addressLocality || '',\n                        'postalCode': event.address.postalCode || ''\n                    }\n                };\n            }\n\n            return schema;\n        });\n    }\n\n    function injectEventSchema(events) {\n        var existing = container.querySelector('script[type=\"application/ld+json\"]');\n        if (existing) {\n            existing.remove();\n        }\n\n        var schemas = buildEventSchema(events);\n        if (!schemas.length) {\n            return;\n        }\n\n        var script = document.createElement('script');\n        script.type = 'application/ld+json';\n        script.textContent = JSON.stringify({\n            '@context': 'https://schema.org',\n            '@graph': schemas\n        });\n        container.appendChild(script);\n    }\n\n    function renderEvents(events) {\n        var collapsed = collapseRecurring(events);\n        var html = '<ul class=\"events__list\">';\n\n        collapsed.forEach(function (event) {\n            var date = formatShortDate(event.startDate);\n            var time = formatTimeRange(event.startDate, event.endDate);\n            var location = formatAddress(event.address);\n            var url = event.publisherUrl || ('https://manchester.placecal.org/events/' + event.id);\n            var datetime = new Date(event.startDate).toISOString();\n\n            html += '<li class=\"event\"><article class=\"event__inner\">';\n            html += '<h2 class=\"event__title\"><a href=\"' + escapeHTML(url) + '\" target=\"_blank\" rel=\"noopener noreferrer\">' + escapeHTML(event.name) + '</a></h2>';\n            var timeStr = escapeHTML(date) + ', ' + escapeHTML(time);\n            if (event.recurrence) {\n                timeStr += ' | ' + recurrenceLabel(event.recurrence);\n            }\n            html += '<p class=\"event__time\"><time datetime=\"' + datetime + '\">' + timeStr + '</time></p>';\n            if (event.description) {\n                html += '<div class=\"event__description\">' + formatDescription(event.description) + '</div>';\n            }\n            if (event.onlineEventUrl) {\n                var linkLabel = 'Join online';\n                if (event.onlineEventUrl.indexOf('meet.google.com') !== -1) {\n                    linkLabel = 'Join on Google Meet';\n                } else if (event.onlineEventUrl.indexOf('discord.com') !== -1) {\n                    linkLabel = 'Join on Discord';\n                } else if (event.onlineEventUrl.indexOf('zoom.us') !== -1) {\n                    linkLabel = 'Join on Zoom';\n                }\n                html += '<p class=\"event__join\"><a href=\"' + escapeHTML(event.onlineEventUrl) + '\" target=\"_blank\" rel=\"noopener noreferrer\">' + linkLabel + '</a></p>';\n            }\n            if (location) {\n                html += '<p class=\"event__location\">' + escapeHTML(location) + '</p>';\n            }\n            html += '</article></li>';\n        });\n\n        html += '</ul>';\n        html += '<p class=\"events__credit\">Events feed powered by <a href=\"https://manchester.placecal.org/partners/geeks-for-social-change\" target=\"_blank\" rel=\"noopener noreferrer\">PlaceCal</a></p>';\n        listEl.innerHTML = html;\n        injectEventSchema(collapsed);\n        showState('events');\n    }\n\n    var CACHE_KEY = 'placecal_events_v3_' + (partnerId || 'all');\n    var CACHE_TTL = 30 * 60 * 1000; // 30 minutes\n\n    function processEvents(events) {\n        if (!events || !events.length) {\n            showState('empty');\n            return;\n        }\n\n        // Trim to futureDays window\n        var cutoff = new Date(new Date().getTime() + futureDays * 24 * 60 * 60 * 1000);\n        var filtered = events.filter(function (event) {\n            return new Date(event.startDate) <= cutoff;\n        });\n\n        // Sort by start date ascending\n        filtered.sort(function (a, b) {\n            return new Date(a.startDate) - new Date(b.startDate);\n        });\n\n        if (!filtered.length) {\n            showState('empty');\n            return;\n        }\n\n        renderEvents(filtered);\n    }\n\n    function getCached() {\n        try {\n            var raw = localStorage.getItem(CACHE_KEY);\n            if (!raw) { return null; }\n            var cached = JSON.parse(raw);\n            if (new Date().getTime() - cached.timestamp > CACHE_TTL) {\n                localStorage.removeItem(CACHE_KEY);\n                return null;\n            }\n            return cached.events;\n        } catch (e) {\n            return null;\n        }\n    }\n\n    function setCache(events) {\n        try {\n            localStorage.setItem(CACHE_KEY, JSON.stringify({\n                timestamp: new Date().getTime(),\n                events: events\n            }));\n        } catch (e) {\n            // Storage full or unavailable, ignore\n        }\n    }\n\n    function fetchEvents() {\n        if (!partnerId) {\n            showState('error');\n            return;\n        }\n\n        var cached = getCached();\n        if (cached) {\n            processEvents(cached);\n            return;\n        }\n\n        var query = '{ partner(id: ' + partnerId + ') { events { ' +\n            'id name summary description startDate endDate repeatFrequency publisherUrl ' +\n            'onlineEventUrl onlineEventUrlType ' +\n            'address { streetAddress postalCode addressLocality } ' +\n            '} } }';\n\n        var url = endpoint + '?query=' + encodeURIComponent(query);\n\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', url, true);\n\n        xhr.onreadystatechange = function () {\n            if (xhr.readyState !== 4) {\n                return;\n            }\n\n            if (xhr.status !== 200) {\n                showState('error');\n                return;\n            }\n\n            try {\n                var response = JSON.parse(xhr.responseText);\n                var events = response.data && response.data.partner && response.data.partner.events;\n                setCache(events);\n                processEvents(events);\n            } catch (e) {\n                showState('error');\n            }\n        };\n\n        xhr.onerror = function () {\n            showState('error');\n        };\n\n        xhr.send();\n    }\n\n    showState('loading');\n    fetchEvents();\n})();\n"]}